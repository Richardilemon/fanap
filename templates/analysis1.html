{% extends "base.html" %}

{% block title %}Fanap: Analysis - Discovery{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col gap-6">
    <div class="flex justify-between items-end">
        <div>
            <div class="flex items-center gap-2 text-sm font-condensed mb-1 uppercase tracking-wider">
                <span class="text-gray-500 font-semibold">Analysis</span>
                <span class="material-symbols-outlined text-gray-600 text-xs">chevron_right</span>
                <span class="text-primary font-bold">Discovery</span>
            </div>
            <h1 class="text-white text-3xl md:text-4xl font-condensed font-bold tracking-tight uppercase">Hidden Gems</h1>
            <p class="text-gray-400 text-sm mt-1">Uncover statistical outliers and high-potential assets.</p>
        </div>
    </div>
</div>

<!-- Filters and Summary Cards -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Filters -->
    <div class="bg-card-dark border border-border-dark rounded-xl p-5 shadow-lg lg:col-span-1 flex flex-col gap-4">
        <div class="flex justify-between items-center mb-1">
            <span class="text-white font-condensed font-bold text-sm uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-sm">filter_list</span> Filters
            </span>
            <span class="text-primary text-xs font-mono bg-primary/10 px-2 py-0.5 rounded border border-primary/20">Active</span>
        </div>
        <form action="{{ url_for('analysis.discovery') }}" method="get">
            <div class="flex flex-col gap-2">
                <div class="flex justify-between text-xs">
                    <span class="text-gray-400">Max Ownership</span>
                    <span class="text-white font-bold" id="ownership-value">{{ max_ownership }}%</span>
                </div>
                <input class="w-full" max="20" min="1" step="0.5" type="range" name="max_own" value="{{ max_ownership }}"
                       oninput="document.getElementById('ownership-value').textContent = this.value + '%'"/>
                <div class="flex justify-between text-[10px] text-gray-600 font-mono">
                    <span>1%</span>
                    <span>20%</span>
                </div>
            </div>
            <button type="submit" class="mt-4 w-full bg-primary text-black font-bold py-2 rounded text-sm hover:bg-primary/90 transition-colors">
                Apply Filters
            </button>
        </form>
    </div>

    <!-- Summary Cards -->
    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-card-dark border border-border-dark rounded-xl p-5 flex items-center gap-4 relative overflow-hidden group">
            <div class="absolute right-0 top-0 h-full w-1 bg-primary"></div>
            <div class="bg-primary/10 p-3 rounded-full text-primary">
                <span class="material-symbols-outlined">diamond</span>
            </div>
            <div>
                <p class="text-gray-400 text-xs font-condensed uppercase tracking-wider mb-0.5">Hidden Gems Found</p>
                <p class="text-2xl font-condensed font-bold text-white">{{ summary.count }}</p>
            </div>
        </div>
        <div class="bg-card-dark border border-border-dark rounded-xl p-5 flex items-center gap-4">
            <div class="bg-background-dark border border-border-dark p-3 rounded-full text-gray-300">
                <span class="material-symbols-outlined">payments</span>
            </div>
            <div>
                <p class="text-gray-400 text-xs font-condensed uppercase tracking-wider mb-0.5">Average Price</p>
                <p class="text-2xl font-condensed font-bold text-white">£{{ summary.avg_price }}m</p>
            </div>
        </div>
        <div class="bg-card-dark border border-border-dark rounded-xl p-5 flex items-center gap-4">
            <div class="bg-background-dark border border-border-dark p-3 rounded-full text-gray-300">
                <span class="material-symbols-outlined">trending_up</span>
            </div>
            <div>
                <p class="text-gray-400 text-xs font-condensed uppercase tracking-wider mb-0.5">Avg Points (Last 5)</p>
                <p class="text-2xl font-condensed font-bold text-white">{{ summary.avg_points }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Table -->
<div class="bg-card-dark border border-border-dark rounded-xl p-0 flex flex-col shadow-lg overflow-hidden">
    <div class="p-5 border-b border-border-dark flex justify-between items-center">
        <h3 class="text-white font-condensed font-bold text-lg flex items-center gap-2">
            <span class="size-2 rounded-full bg-primary animate-pulse"></span>
            Top Differentials
        </h3>
        <span class="text-xs text-gray-500">Ownership < {{ max_ownership }}%</span>
    </div>
    <div class="overflow-auto">
        <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-500 font-condensed uppercase bg-background-dark/50 sticky top-0 backdrop-blur-sm z-10">
                <tr>
                    <th class="py-3 pl-5 pr-2 font-semibold">Player</th>
                    <th class="py-3 px-2 font-semibold text-right">Price</th>
                    <th class="py-3 px-2 font-semibold text-right">Own%</th>
                    <th class="py-3 px-2 font-semibold text-right">Pts (L5)</th>
                    <th class="py-3 px-2 font-semibold text-right">Goals</th>
                    <th class="py-3 px-2 font-semibold text-right">Assists</th>
                    <th class="py-3 px-2 font-semibold text-right text-primary">xGI</th>
                    <th class="py-3 pl-2 pr-5 font-semibold text-right">Next 3</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border-dark">
                {% for gem in gems %}
                <tr class="group cursor-pointer hover:bg-white/5 transition-colors">
                    <td class="py-3 pl-5 pr-2">
                        <a href="{{ url_for('analysis.player_research', name=gem.player_name) }}" class="block">
                            <div class="font-bold text-white group-hover:text-primary transition-colors">{{ gem.player_name }}</div>
                            <div class="text-[10px] text-gray-500 uppercase">{{ gem.team }}</div>
                        </a>
                    </td>
                    <td class="py-3 px-2 text-right text-white font-medium">£{{ gem.current_price }}m</td>
                    <td class="py-3 px-2 text-right text-gray-400">{{ gem.ownership }}%</td>
                    <td class="py-3 px-2 text-right text-white font-bold">{{ gem.points_last_5 }}</td>
                    <td class="py-3 px-2 text-right text-gray-300">{{ gem.goals }}</td>
                    <td class="py-3 px-2 text-right text-gray-300">{{ gem.assists }}</td>
                    <td class="py-3 px-2 text-right text-primary font-bold">{{ (gem.avg_xg or 0) + (gem.avg_xa or 0) | round(2) }}</td>
                    <td class="py-3 pl-2 pr-5 text-right">
                        <div class="flex justify-end gap-1">
                            {% for fixture in gem.fixtures[:3] %}
                            <span class="size-2 rounded-full {{ 'bg-green-500' if fixture.difficulty <= 2 else 'bg-gray-500' if fixture.difficulty == 3 else 'bg-red-500' }}"
                                  title="{{ fixture.opponent }} ({{ fixture.venue }}) - FDR {{ fixture.difficulty }}"></span>
                            {% endfor %}
                            {% if gem.fixtures | length < 3 %}
                            {% for _ in range(3 - gem.fixtures | length) %}
                            <span class="size-2 rounded-full bg-gray-700" title="No fixture"></span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="py-8 text-center text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">search_off</span>
                        <p>No hidden gems found with current filters. Try increasing max ownership.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
