{% extends "base.html" %}

{% block title %}Fanap: Analysis - Player Research{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col gap-6">
    <div class="flex justify-between items-end">
        <div>
            <div class="flex items-center gap-2 text-sm font-condensed mb-1 uppercase tracking-wider">
                <span class="text-gray-500 font-semibold">Analysis</span>
                <span class="material-symbols-outlined text-gray-600 text-xs">chevron_right</span>
                <span class="text-primary font-bold">Player Research</span>
            </div>
            <h1 class="text-white text-3xl md:text-4xl font-condensed font-bold tracking-tight uppercase">Player Research</h1>
            <p class="text-gray-400 text-sm mt-1">Deep dive into individual player performance and statistics.</p>
        </div>
    </div>
</div>

<!-- Player Search -->
<div class="bg-card-dark border border-border-dark rounded-xl p-6 shadow-lg">
    <form action="{{ url_for('analysis.player_research') }}" method="get" class="flex flex-col md:flex-row gap-4 items-end">
        <div class="flex-1">
            <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block font-condensed">Player Name</label>
            <input type="text" name="name" value="{{ player_name }}" placeholder="e.g., Haaland, Salah, Palmer..."
                   class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none"/>
        </div>
        <button type="submit" class="bg-primary text-black font-bold px-8 py-3 rounded-lg hover:bg-primary/90 transition-colors font-condensed uppercase">
            Research
        </button>
    </form>
</div>

{% if player %}
<!-- Player Header Card -->
<div class="bg-card-dark border border-border-dark rounded-xl p-6 shadow-lg relative overflow-hidden">
    <div class="absolute top-0 right-0 w-96 h-96 bg-primary/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
    <div class="flex flex-col md:flex-row gap-6 justify-between items-start md:items-center relative z-10">
        <div class="flex items-center gap-6">
            <!-- Player Avatar -->
            <div class="relative">
                <div class="size-20 rounded-xl bg-gray-600 flex items-center justify-center text-3xl font-bold text-white border-2 border-primary/30">
                    {{ player.player_name[:2] | upper }}
                </div>
            </div>
            <div class="flex flex-col">
                <h2 class="text-3xl font-bold text-white font-condensed tracking-tight uppercase">{{ player.player_name }}</h2>
                <div class="flex items-center gap-3 mt-1 text-gray-400 text-sm font-medium">
                    <span class="bg-background-dark px-2 py-0.5 rounded text-white text-xs uppercase tracking-wider border border-border-dark">{{ player.position }}</span>
                    <span>{{ player.team }}</span>
                </div>
                <div class="flex items-center gap-4 mt-3">
                    <div class="flex flex-col">
                        <span class="text-[11px] text-gray-500 uppercase tracking-wider font-semibold">Price</span>
                        <span class="text-xl font-bold text-primary">Â£{{ player.current_price }}m</span>
                    </div>
                    <div class="w-px h-8 bg-border-dark"></div>
                    <div class="flex flex-col">
                        <span class="text-[11px] text-gray-500 uppercase tracking-wider font-semibold">Ownership</span>
                        <span class="text-xl font-bold text-white">{{ player.ownership }}%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-3 w-full md:w-auto mt-4 md:mt-0">
            <a href="{{ url_for('analysis.compare', p1=player.player_name) }}"
               class="flex-1 md:flex-none h-11 px-6 rounded-lg bg-background-dark border border-border-dark hover:border-primary/30 text-white font-medium text-sm transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-[20px]">compare_arrows</span>
                Compare
            </a>
        </div>
    </div>
</div>

<!-- KPI Tiles -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="bg-card-dark rounded-lg p-5 border border-border-dark hover:border-primary/30 transition-colors group">
        <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Total Points</span>
            <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors text-[20px]">star</span>
        </div>
        <div class="text-3xl font-bold text-white tracking-tight">{{ player.points }}</div>
        <div class="text-primary text-xs font-medium mt-1 flex items-center gap-1">
            {{ player.points_per_game }} pts/game
        </div>
    </div>
    <div class="bg-card-dark rounded-lg p-5 border border-border-dark hover:border-primary/30 transition-colors group">
        <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Expected Goals</span>
            <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors text-[20px]">sports_soccer</span>
        </div>
        <div class="text-3xl font-bold text-white tracking-tight">{{ player.avg_xg }}</div>
        <div class="text-gray-500 text-xs font-medium mt-1">Actual: {{ player.goals }}</div>
    </div>
    <div class="bg-card-dark rounded-lg p-5 border border-border-dark hover:border-primary/30 transition-colors group">
        <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Expected Assists</span>
            <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors text-[20px]">assistant</span>
        </div>
        <div class="text-3xl font-bold text-white tracking-tight">{{ player.avg_xa }}</div>
        <div class="text-gray-500 text-xs font-medium mt-1">Actual: {{ player.assists }}</div>
    </div>
    <div class="bg-card-dark rounded-lg p-5 border border-border-dark hover:border-primary/30 transition-colors group">
        <div class="flex justify-between items-start mb-2">
            <span class="text-gray-400 text-sm font-medium">Bonus Points</span>
            <span class="material-symbols-outlined text-gray-600 group-hover:text-primary transition-colors text-[20px]">workspace_premium</span>
        </div>
        <div class="text-3xl font-bold text-white tracking-tight">{{ player.bonus }}</div>
        <div class="text-gray-500 text-xs font-medium mt-1">{{ player.games_played }} games played</div>
    </div>
</div>

<!-- Main Analysis Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Recent Form -->
    <div class="lg:col-span-2 flex flex-col gap-6">
        <!-- Recent Form Table -->
        <div class="bg-card-dark rounded-xl border border-border-dark p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-white text-lg font-bold uppercase tracking-wider font-condensed flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary text-sm">trending_up</span>
                    Recent Form
                </h3>
                <span class="text-xs text-gray-500">Last 10 gameweeks</span>
            </div>

            {% if form %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-border-dark text-xs uppercase text-gray-500 font-condensed">
                            <th class="py-3 font-semibold">GW</th>
                            <th class="py-3 font-semibold">Opponent</th>
                            <th class="py-3 font-semibold text-right">Pts</th>
                            <th class="py-3 font-semibold text-right">Mins</th>
                            <th class="py-3 font-semibold text-right">G</th>
                            <th class="py-3 font-semibold text-right">A</th>
                            <th class="py-3 font-semibold text-right text-primary">xG</th>
                            <th class="py-3 font-semibold text-right text-primary">xA</th>
                            <th class="py-3 font-semibold text-right">BPS</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        {% for gw in form %}
                        <tr class="border-b border-border-dark/50 group hover:bg-white/5 transition-colors">
                            <td class="py-3 text-white font-medium">{{ gw.gameweek }}</td>
                            <td class="py-3 text-gray-400">{{ gw.opponent }} ({{ gw.venue }})</td>
                            <td class="py-3 text-right {{ 'text-primary font-bold' if gw.points >= 6 else 'text-white' }}">{{ gw.points }}</td>
                            <td class="py-3 text-right text-gray-400">{{ gw.minutes }}</td>
                            <td class="py-3 text-right {{ 'text-green-400 font-bold' if gw.goals > 0 else 'text-gray-500' }}">{{ gw.goals }}</td>
                            <td class="py-3 text-right {{ 'text-green-400 font-bold' if gw.assists > 0 else 'text-gray-500' }}">{{ gw.assists }}</td>
                            <td class="py-3 text-right text-primary">{{ gw.xg }}</td>
                            <td class="py-3 text-right text-primary">{{ gw.xa }}</td>
                            <td class="py-3 text-right text-gray-400">{{ gw.bonus }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8">
                <span class="material-symbols-outlined text-4xl text-gray-600 mb-2">search_off</span>
                <p class="text-gray-400">No recent form data available</p>
            </div>
            {% endif %}
        </div>

        <!-- Season Stats Breakdown -->
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div class="bg-card-dark p-4 rounded-lg border border-border-dark">
                <p class="text-gray-400 text-xs uppercase font-semibold mb-2 font-condensed">Attacking</p>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-500">Goals</span>
                        <span class="text-sm text-white font-bold">{{ player.goals }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-500">Assists</span>
                        <span class="text-sm text-white font-bold">{{ player.assists }}</span>
                    </div>
                </div>
            </div>
            <div class="bg-card-dark p-4 rounded-lg border border-border-dark">
                <p class="text-gray-400 text-xs uppercase font-semibold mb-2 font-condensed">Expected</p>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-500">xG</span>
                        <span class="text-sm text-primary font-bold">{{ player.avg_xg }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-500">xA</span>
                        <span class="text-sm text-primary font-bold">{{ player.avg_xa }}</span>
                    </div>
                </div>
            </div>
            <div class="bg-card-dark p-4 rounded-lg border border-border-dark">
                <p class="text-gray-400 text-xs uppercase font-semibold mb-2 font-condensed">Performance</p>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-500">Bonus</span>
                        <span class="text-sm text-white font-bold">{{ player.bonus }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-500">Games</span>
                        <span class="text-sm text-white font-bold">{{ player.games_played }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Fixtures -->
    <div class="flex flex-col gap-6">
        <!-- Upcoming Fixtures -->
        <div class="bg-card-dark rounded-xl border border-border-dark p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-lg font-bold uppercase tracking-wider font-condensed flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary text-sm">calendar_month</span>
                    Next 5
                </h3>
            </div>

            {% if fixtures %}
            <div class="flex flex-col gap-3">
                {% for fixture in fixtures[:5] %}
                <div class="flex items-center justify-between p-3 rounded-lg bg-background-dark border border-l-4 border-border-dark {{ fixture.difficulty | fdr_border }}">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-500 font-bold">GW{{ fixture.gameweek }}</span>
                        <span class="text-white font-bold text-sm">{{ fixture.opponent }} ({{ fixture.venue }})</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] px-1.5 py-0.5 rounded font-bold {{ fixture.difficulty | fdr_color }}">FDR {{ fixture.difficulty }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <span class="material-symbols-outlined text-4xl text-gray-600 mb-2">event_busy</span>
                <p class="text-gray-400">No upcoming fixtures</p>
            </div>
            {% endif %}
        </div>

        <!-- Quick Stats -->
        <div class="bg-card-dark rounded-xl border border-border-dark p-6 flex-1">
            <h3 class="text-white text-lg font-bold uppercase tracking-wider font-condensed mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-sm">info</span>
                Quick Stats
            </h3>
            <div class="flex flex-col gap-3">
                <div class="flex justify-between items-center py-2 border-b border-border-dark/50">
                    <span class="text-gray-400 text-sm">Total Points</span>
                    <span class="text-white font-bold">{{ player.points }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border-dark/50">
                    <span class="text-gray-400 text-sm">Points/Game</span>
                    <span class="text-white font-bold">{{ player.points_per_game }}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border-dark/50">
                    <span class="text-gray-400 text-sm">xGI (xG + xA)</span>
                    <span class="text-primary font-bold">{{ (player.avg_xg|float + player.avg_xa|float)|round(2) }}</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-400 text-sm">Goal Involvement</span>
                    <span class="text-white font-bold">{{ player.goals + player.assists }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% elif player_name %}
<!-- No results -->
<div class="bg-card-dark border border-border-dark rounded-xl p-8 text-center">
    <span class="material-symbols-outlined text-4xl text-gray-500 mb-2">person_search</span>
    <p class="text-gray-400">Could not find player "{{ player_name }}". Please check the name and try again.</p>
</div>
{% else %}
<!-- Empty state -->
<div class="bg-card-dark border border-border-dark rounded-xl p-12 text-center">
    <span class="material-symbols-outlined text-6xl text-gray-600 mb-4">person_search</span>
    <h3 class="text-white font-condensed font-bold text-xl mb-2 uppercase">Research a Player</h3>
    <p class="text-gray-400 max-w-md mx-auto">Enter a player name above to see detailed statistics, recent form, and upcoming fixtures.</p>
    <div class="flex justify-center gap-4 mt-6">
        <a href="{{ url_for('analysis.player_research', name='Haaland') }}" class="text-primary hover:text-white text-sm font-medium transition-colors">
            Try: Haaland
        </a>
        <a href="{{ url_for('analysis.player_research', name='Salah') }}" class="text-primary hover:text-white text-sm font-medium transition-colors">
            Try: Salah
        </a>
        <a href="{{ url_for('analysis.player_research', name='Palmer') }}" class="text-primary hover:text-white text-sm font-medium transition-colors">
            Try: Palmer
        </a>
    </div>
</div>
{% endif %}
{% endblock %}
